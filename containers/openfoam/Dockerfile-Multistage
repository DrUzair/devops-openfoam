# Multi-stage build for OpenFOAM simulation platform
FROM openfoam/openfoam9-paraview56 AS base

# Set environment variables for parameterization
ENV REYNOLDS_NUMBER=100 \
    MESH_RESOLUTION=20 \
    SIMULATION_TIME=1000

# Create working directory
WORKDIR /opt/simulation

# Install system dependencies as root
USER root
RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    jq \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Install Python packages
RUN pip3 install numpy matplotlib pandas

# Create and switch to foamuser
RUN useradd -m -s /bin/bash foamuser && \
    chown -R foamuser:foamuser /opt/simulation

# Copy ALL case files
COPY --chown=foamuser:foamuser ./simulations/. ./cases/
COPY --chown=foamuser:foamuser ./scripts/. ./scripts/

# Make scripts executable (now we have proper ownership)
RUN chmod +x scripts/*.sh

# Source OpenFOAM environment
RUN echo "source /opt/openfoam9/etc/bashrc" >> /etc/bash.bashrc

# Production stage
FROM base AS production

USER foamuser

# Health check for container orchestration
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s \
  CMD ./scripts/health-check.sh || exit 1

  FROM base AS production

# Default command
CMD ["./scripts/run-parametric-study.sh"]